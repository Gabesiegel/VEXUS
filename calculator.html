<!DOCTYPE HTML>
<html lang="en">
<head>
  <title>VExUS AI - Vertex Integration</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  
  <!-- Optional Phantom Template CSS -->
  <link rel="stylesheet" href="html5up-phantom/assets/css/main.css" />
  <link rel="stylesheet" href="html5up-phantom/assets/css/fontawesome-all.min.css" />
  <noscript><link rel="stylesheet" href="html5up-phantom/assets/css/noscript.css" /></noscript>

  <style>
    /* Minimal styling to illustrate the "green" model-ready class. */
    .model-status {
      background-color: #ffc107; /* default yellow */
      color: #333;
      padding: 8px;
      border-radius: 5px;
      max-width: 600px;
      margin: 10px auto;
      text-align: center;
      font-weight: 500;
    }
    .model-ready {
      background-color: #28a745; /* green if ready */
      color: #fff;
    }

    .cannot-calc-note {
      color: #dc3545;
    }
  </style>
</head>
<body>
  <h1>VExUS AI - Stepwise Image Recognition &amp; Scoring</h1>

  <!-- HEPATIC Vein Section -->
  <section>
    <h2>Hepatic Vein</h2>
    <div id="hepaticModelStatus" class="model-status">
      Ready for classification via Vertex AI
    </div>

    <div style="border: 2px dashed #ccc; padding: 20px; max-width: 400px; margin: auto;" onclick="confirmPHIUpload('hepaticImageInput')">
      <p>Click to upload a Hepatic Vein image</p>
      <input type="file" id="hepaticImageInput" style="display: none;" accept="image/*">
    </div>
    <img id="hepaticPreview" style="display: none; max-width: 400px; margin: 15px auto; border: 1px solid #ccc;">

    <div id="hepaticResult">Hepatic recognition result will appear here...</div>
    <div id="hepaticTopResults"></div>

    <select id="hepaticDropdown">
      <option value="">-- Select --</option>
      <option value="HV Normal">HV Normal</option>
      <option value="HV Mild">HV Mild</option>
      <option value="HV Severe">HV Severe</option>
      <option value="Confidence of waveform < 50%">Confidence of waveform < 50%</option>
    </select>
    <div id="hepaticErrorNote" class="cannot-calc-note" style="display:none;">
      Probability below 50%. Please upload a higher quality image.
    </div>
  </section>

  <script>
    /********************************************************
     * 1) Confirm PHI
     ********************************************************/
    function confirmPHIUpload(inputId) {
      const message = "Confirm that this image does NOT contain PHI (Protected Health Info).";
      if (confirm(message)) {
        document.getElementById(inputId).click();
      }
    }

    /********************************************************
     * 2) Convert <img> to Base64
     ********************************************************/
    function convertImgToBase64(imgEl) {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        canvas.width = imgEl.naturalWidth;
        canvas.height = imgEl.naturalHeight;
        canvas.getContext('2d').drawImage(imgEl, 0, 0);
        
        const dataURL = canvas.toDataURL('image/png'); 
        // dataURL -> "data:image/png;base64,iVBOR..."
        const base64 = dataURL.replace(/^data:image\/(png|jpeg);base64,/, '');
        resolve(base64);
      });
    }

    /********************************************************
     * 3) Classify with Vertex AI (Hepatic Only)
     ********************************************************/
    async function classifyImageViaVertexAi(imgEl, labelSet, resultId, topResultsId, dropdownId, errorNoteId) {
      try {
        // A) Convert to base64
        const base64Image = await convertImgToBase64(imgEl);

        // B) Get token from /refresh-token
        const tokenResp = await fetch('/refresh-token', { method: 'POST' });
        if (!tokenResp.ok) {
          throw new Error(`Token request failed: ${tokenResp.statusText}`);
        }
        const tokenData = await tokenResp.json();
        if (!tokenData.access_token) {
          throw new Error("No access_token returned from /refresh-token");
        }

        // Turn hepatic model to green
        const hepaticStatus = document.getElementById('hepaticModelStatus');
        hepaticStatus.classList.add('model-ready');
        hepaticStatus.textContent = "Hepatic Model Ready!";

        // C) Call your Vertex AI endpoint
        // Replace PROJECT_ID, ENDPOINT_ID with your real IDs
        const endpointUrl = 'https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/endpoints/ENDPOINT_ID:predict';

        const body = {
          instances: [
            { content: base64Image }
          ]
        };

        const vertexRes = await fetch(endpointUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + tokenData.access_token
          },
          body: JSON.stringify(body)
        });

        if (!vertexRes.ok) {
          const errText = await vertexRes.text();
          throw new Error(`Vertex error: ${errText}`);
        }

        const vertexData = await vertexRes.json();
        if (!vertexData.predictions || !vertexData.predictions[0]) {
          throw new Error("No predictions returned from Vertex AI");
        }

        // Suppose "confidences": [0.8, 0.15, 0.05]
        const confs = vertexData.predictions[0].confidences;
        const combined = labelSet.map((label, idx) => ({
          label,
          probability: confs[idx]
        }));

        combined.sort((a,b) => b.probability - a.probability);
        const top1 = combined[0];
        const top1Pct = (top1.probability * 100).toFixed(1);

        // Show result
        document.getElementById(resultId).textContent = `Top: ${top1.label} (${top1Pct}%)`;

        const top3Html = combined.slice(0, 3)
          .map(x => `${x.label}: ${(x.probability * 100).toFixed(1)}%`)
          .join('<br>');
        document.getElementById(topResultsId).innerHTML = `<strong>Top 3:</strong><br>${top3Html}`;

        // Autofill if > 50%
        const dropdown = document.getElementById(dropdownId);
        const errorNote = document.getElementById(errorNoteId);

        if (top1.probability > 0.5) {
          // Attempt to match label
          const opt = [...dropdown.options].find(o => o.value === top1.label);
          if (opt) dropdown.value = opt.value;
          errorNote.style.display = "none";
        } else {
          dropdown.value = "Confidence of waveform < 50%";
          errorNote.style.display = "block";
        }
      } catch(err) {
        console.error("Classification Error:", err);
        document.getElementById(resultId).textContent = "Error: " + err.message;
      }
    }

    /********************************************************
     * 4) Listen for Hepatic File Upload
     ********************************************************/
    document.getElementById('hepaticImageInput').addEventListener('change', function(){
      const file = this.files[0];
      if (!file) return;

      // Show preview
      const preview = document.getElementById('hepaticPreview');
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';

      // Once loaded, call classify
      preview.onload = function() {
        const hepaticLabels = ["HV Normal", "HV Mild", "HV Severe"];
        classifyImageViaVertexAi(
          preview, 
          hepaticLabels, 
          'hepaticResult', 
          'hepaticTopResults', 
          'hepaticDropdown', 
          'hepaticErrorNote'
        );
      };
    });
  </script>
</body>
</html>
