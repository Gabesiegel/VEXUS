steps:
# Install dependencies
- name: 'node:18'
  entrypoint: npm
  args: ['ci']  # Using ci instead of install for more reliable builds

# Build the React app
- name: 'node:18'
  entrypoint: npm
  args: ['run', 'build']

# Deploy to Cloud Run
- name: 'gcr.io/cloud-builders/gcloud'
  args:
    - 'run'
    - 'deploy'
    - 'vexus-web'
    - '--region'
    - 'us-central1'
    - '--allow-unauthenticated'
    - '--source'
    - '.'
    - '--set-env-vars'
    - 'VERTEX_AI_ENDPOINT=projects/plucky-weaver-450819-k7/locations/us-central1/endpoints/1401033999995895808'
    - '--min-instances'
    - '1'
    - '--memory'
    - '1Gi'
    - '--cpu'
    - '1'
    - '--timeout'
    - '3600'
    - '--port'
    - '8080'
    - '--execution-environment'
    - 'gen2'
    - '--concurrency'
    - '80'
    - '--startup-cpu-boost'

timeout: "900s"
options:
  logging: "CLOUD_LOGGING_ONLY"
serviceAccount: "projects/plucky-weaver-450819-k7/serviceAccounts/vertex-service-account@plucky-weaver-450819-k7.iam.gserviceaccount.com"
