Server running on port 3002
Configuration: {
  "projectId": "plucky-weaver-450819-k7",
  "projectNumber": "456295042668",
  "location": "us-central1",
  "endpointIds": {
    "hepatic": "8159951878260523008",
    "portal": "2970410926785691648",
    "renal": "1148704877514326016"
  },
  "onDemandEndpointService": "https://endpoints-on-demand-456295042668.us-central1.run.app",
  "lastUpdated": "2025-03-08T20:26:19.249Z",
  "developer": "Gabesiegel",
  "bucketName": "vexus-ai-images-plucky-weaver-450819-k7-20250223131511"
}
[2025-03-08T20:26:20.014Z] Requesting: /api/preload-endpoint
Prewarming portal endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:26:22.582Z] Requesting: /api/preload-endpoint
Prewarming renal endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:26:22.939Z] Requesting: /api/health
Health check requested
[2025-03-08T20:26:30.756Z] Requesting: /api/health
Health check requested
[2025-03-08T20:26:58.667Z] Requesting: /api/health
Health check requested
[2025-03-08T20:27:02.297Z] Requesting: /api/local-health
[2025-03-08T20:27:10.897Z] Requesting: /calculator.html
[2025-03-08T20:27:11.969Z] Requesting: /api/preload-endpoint
Prewarming hepatic endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:27:13.320Z] Requesting: /api/preload-endpoint
Prewarming portal endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:27:14.674Z] Requesting: /api/preload-endpoint
Prewarming renal endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:27:18.478Z] Requesting: /api/test-endpoint
Testing endpoint connection for vein type: hepatic
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:27:18.640Z] Requesting: /api/predict
Received prediction request
Prediction request for hepatic vein
Processing image from instances array
Preparing image for prediction, type: image/png
Image content type: string
Image content starts with: iVBORw0KGgoAAAANSUhE...
Image content length: 689912 characters
Is valid base64 (without data URL): true
Image content appears to be already in base64 format without prefix
Image prepared for prediction, mime type: image/png
Calling on-demand service for prediction
Using on-demand service URL: https://endpoints-on-demand-456295042668.us-central1.run.app
[DIAGNOSTIC] REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "veinType": "hepatic",
  "imageType": "image/png",
  "hasInstances": true,
  "instanceCount": 1,
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:504:15
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[DIAGNOSTIC] ONDEMAND_REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465638754
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:529:19
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 1/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465638754
  }
}
API call attempt 1 failed: API call failed with status 502: 
Waiting 2000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 2/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465638754
  }
}
API call attempt 2 failed: API call failed with status 404: <!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>

Waiting 4000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 3/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465638754
  }
}
API call attempt 3 failed: API call failed with status 502: 
On-demand service error: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
[DIAGNOSTIC] ONDEMAND_ERROR - hepatic
[DIAGNOSTIC] Error: API call failed with status 502: 
[DIAGNOSTIC] Stack: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
Error type: Error
Falling back to direct Vertex AI call
Making direct Vertex AI prediction for hepatic vein
Getting credentials from Secret Manager...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
Initializing Vertex AI client with Secret Manager credentials
Using Vertex AI API endpoint: us-central1-aiplatform.googleapis.com
Configured endpoints - Hepatic: 8159951878260523008, Portal: 2970410926785691648, Renal: 1148704877514326016
Sending direct prediction request to endpoint: projects/456295042668/locations/us-central1/endpoints/8159951878260523008
[DIAGNOSTIC] DIRECT_REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "endpoint": "projects/456295042668/locations/us-central1/endpoints/8159951878260523008",
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at makeDirectVertexAIPrediction (file:///Users/gabe/VEXUS/server.js:1243:15)
    at async file:///Users/gabe/VEXUS/server.js:605:36
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - hepatic
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 79 aa 59 cb 0d 9f 6a 40 39 93 9d fb 08 43 ee 0a 40 49 c0 8a 6a f3 4e 42 c0 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 08 52 5b 04 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 47 67> ]
  },
  options: {}
}
Scheduling shutdown for hepatic endpoint in 5 minutes
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - hepatic
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 79 aa 59 cb 0d 9f 6a 40 39 93 9d fb 08 43 ee 0a 40 49 c0 8a 6a f3 4e 42 c0 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 08 52 5b 04 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 47 67> ]
  },
  options: {}
}
Scheduling shutdown for hepatic endpoint in 5 minutes
Returning prediction error after direct call failed
Prediction request completed in 19976ms
[2025-03-08T20:27:38.776Z] Requesting: /api/test-endpoint
Testing endpoint connection for vein type: portal
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:27:38.936Z] Requesting: /api/predict
Received prediction request
Prediction request for portal vein
Processing image from instances array
Preparing image for prediction, type: image/png
Image content type: string
Image content starts with: iVBORw0KGgoAAAANSUhE...
Image content length: 518520 characters
Is valid base64 (without data URL): true
Image content appears to be already in base64 format without prefix
Image prepared for prediction, mime type: image/png
Calling on-demand service for prediction
Using on-demand service URL: https://endpoints-on-demand-456295042668.us-central1.run.app
[DIAGNOSTIC] REQUEST - portal
[DIAGNOSTIC] Data: {
  "veinType": "portal",
  "imageType": "image/png",
  "hasInstances": true,
  "instanceCount": 1,
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:504:15
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[DIAGNOSTIC] ONDEMAND_REQUEST - portal
[DIAGNOSTIC] Data: {
  "instances": [
    {
      "content": "[BASE64 DATA - 518520 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "portal",
    "imageType": "image/png",
    "timestamp": 1741465659021
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:529:19
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 1/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 518520 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "portal",
    "imageType": "image/png",
    "timestamp": 1741465659021
  }
}
API call attempt 1 failed: API call failed with status 502: 
Waiting 2000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 2/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 518520 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "portal",
    "imageType": "image/png",
    "timestamp": 1741465659021
  }
}
API call attempt 2 failed: API call failed with status 502: 
Waiting 4000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 3/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 518520 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "portal",
    "imageType": "image/png",
    "timestamp": 1741465659021
  }
}
API call attempt 3 failed: API call failed with status 502: 
On-demand service error: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
[DIAGNOSTIC] ONDEMAND_ERROR - portal
[DIAGNOSTIC] Error: API call failed with status 502: 
[DIAGNOSTIC] Stack: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
Error type: Error
Falling back to direct Vertex AI call
Making direct Vertex AI prediction for portal vein
Sending direct prediction request to endpoint: projects/456295042668/locations/us-central1/endpoints/2970410926785691648
[DIAGNOSTIC] DIRECT_REQUEST - portal
[DIAGNOSTIC] Data: {
  "endpoint": "projects/456295042668/locations/us-central1/endpoints/2970410926785691648",
  "instances": [
    {
      "content": "[BASE64 DATA - 518520 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at makeDirectVertexAIPrediction (file:///Users/gabe/VEXUS/server.js:1243:15)
    at file:///Users/gabe/VEXUS/server.js:605:42
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - portal
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 a2 53 7f d9 96 09 69 40 39 56 09 5a f4 ca cc 10 40 49 b7 c9 74 ed 4b 64 be 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 c3 bd b8 02 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 47 67> ]
  },
  options: {}
}
Scheduling shutdown for portal endpoint in 5 minutes
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - portal
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 a2 53 7f d9 96 09 69 40 39 56 09 5a f4 ca cc 10 40 49 b7 c9 74 ed 4b 64 be 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 c3 bd b8 02 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 47 67> ]
  },
  options: {}
}
Scheduling shutdown for portal endpoint in 5 minutes
Returning prediction error after direct call failed
Prediction request completed in 14256ms
[2025-03-08T20:28:46.785Z] Requesting: /api/health
Health check requested
[2025-03-08T20:28:57.406Z] Requesting: /api/test-endpoint
Testing endpoint connection for vein type: hepatic
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:29:00.325Z] Requesting: /api/health
Health check requested
[2025-03-08T20:29:03.637Z] Requesting: /calculator.html
[2025-03-08T20:29:04.692Z] Requesting: /api/preload-endpoint
Prewarming hepatic endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:29:06.024Z] Requesting: /api/preload-endpoint
Prewarming portal endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:29:07.339Z] Requesting: /api/preload-endpoint
Prewarming renal endpoint...
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:29:10.738Z] Requesting: /api/test-endpoint
Testing endpoint connection for vein type: hepatic
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[2025-03-08T20:29:10.910Z] Requesting: /api/predict
Received prediction request
Prediction request for hepatic vein
Processing image from instances array
Preparing image for prediction, type: image/png
Image content type: string
Image content starts with: iVBORw0KGgoAAAANSUhE...
Image content length: 689912 characters
Is valid base64 (without data URL): true
Image content appears to be already in base64 format without prefix
Image prepared for prediction, mime type: image/png
Calling on-demand service for prediction
Using on-demand service URL: https://endpoints-on-demand-456295042668.us-central1.run.app
[DIAGNOSTIC] REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "veinType": "hepatic",
  "imageType": "image/png",
  "hasInstances": true,
  "instanceCount": 1,
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:504:15
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[DIAGNOSTIC] ONDEMAND_REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465750994
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:529:19
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 1/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465750994
  }
}
API call attempt 1 failed: API call failed with status 502: 
Waiting 2000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 2/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465750994
  }
}
API call attempt 2 failed: API call failed with status 502: 
Waiting 4000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 3/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465750994
  }
}
API call attempt 3 failed: API call failed with status 502: 
On-demand service error: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
[DIAGNOSTIC] ONDEMAND_ERROR - hepatic
[DIAGNOSTIC] Error: API call failed with status 502: 
[DIAGNOSTIC] Stack: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
Error type: Error
Falling back to direct Vertex AI call
Making direct Vertex AI prediction for hepatic vein
Sending direct prediction request to endpoint: projects/456295042668/locations/us-central1/endpoints/8159951878260523008
[DIAGNOSTIC] DIRECT_REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "endpoint": "projects/456295042668/locations/us-central1/endpoints/8159951878260523008",
  "instances": [
    {
      "content": "[BASE64 DATA - 689912 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at makeDirectVertexAIPrediction (file:///Users/gabe/VEXUS/server.js:1243:15)
    at file:///Users/gabe/VEXUS/server.js:605:42
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - hepatic
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 f4 d9 83 89 f3 73 6c 40 39 a2 30 85 51 87 02 13 40 49 56 79 a4 a6 1b 24 c4 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 0b 07 0e 02 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 45 41> ]
  },
  options: {}
}
Scheduling shutdown for hepatic endpoint in 5 minutes
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - hepatic
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 f4 d9 83 89 f3 73 6c 40 39 a2 30 85 51 87 02 13 40 49 56 79 a4 a6 1b 24 c4 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 0b 07 0e 02 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 45 41> ]
  },
  options: {}
}
Scheduling shutdown for hepatic endpoint in 5 minutes
Returning prediction error after direct call failed
Prediction request completed in 14214ms
[2025-03-08T20:30:17.820Z] Requesting: /api/predict
Received prediction request
Prediction request for hepatic vein
Processing image from instances array
Preparing image for prediction, type: image/png
Image content type: string
Image content starts with: iVBORw0KGgoAAAANSUhE...
Image content length: 1053532 characters
Is valid base64 (without data URL): true
Image content appears to be already in base64 format without prefix
Image prepared for prediction, mime type: image/png
Calling on-demand service for prediction
Using on-demand service URL: https://endpoints-on-demand-456295042668.us-central1.run.app
[DIAGNOSTIC] REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "veinType": "hepatic",
  "imageType": "image/png",
  "hasInstances": true,
  "instanceCount": 1,
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:504:15
Getting credentials from Secret Manager: projects/plucky-weaver-450819-k7/secrets/KEY/versions/latest
[DIAGNOSTIC] ONDEMAND_REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "instances": [
    {
      "content": "[BASE64 DATA - 1053532 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465817944
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at file:///Users/gabe/VEXUS/server.js:529:19
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 1/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 1053532 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465817944
  }
}
API call attempt 1 failed: API call failed with status 502: 
Waiting 2000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 2/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 1053532 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465817944
  }
}
API call attempt 2 failed: API call failed with status 502: 
Waiting 4000ms before retry...
Making API call to https://endpoints-on-demand-456295042668.us-central1.run.app (attempt 3/3)
Payload: {
  "instances": [
    {
      "content": "[BASE64 DATA - 1053532 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  },
  "metadata": {
    "veinType": "hepatic",
    "imageType": "image/png",
    "timestamp": 1741465817944
  }
}
API call attempt 3 failed: API call failed with status 502: 
On-demand service error: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
[DIAGNOSTIC] ONDEMAND_ERROR - hepatic
[DIAGNOSTIC] Error: API call failed with status 502: 
[DIAGNOSTIC] Stack: Error: API call failed with status 502: 
    at makeApiCallWithRetry (file:///Users/gabe/VEXUS/server.js:1294:23)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async file:///Users/gabe/VEXUS/server.js:532:28
Error type: Error
Falling back to direct Vertex AI call
Making direct Vertex AI prediction for hepatic vein
Sending direct prediction request to endpoint: projects/456295042668/locations/us-central1/endpoints/8159951878260523008
[DIAGNOSTIC] DIRECT_REQUEST - hepatic
[DIAGNOSTIC] Data: {
  "endpoint": "projects/456295042668/locations/us-central1/endpoints/8159951878260523008",
  "instances": [
    {
      "content": "[BASE64 DATA - 1053532 chars]"
    }
  ],
  "parameters": {
    "confidenceThreshold": 0,
    "maxPredictions": 5
  }
}
Error writing to debug log file: ReferenceError: sanitizedData is not defined
    at logDiagnostics (file:///Users/gabe/VEXUS/server.js:1146:49)
    at makeDirectVertexAIPrediction (file:///Users/gabe/VEXUS/server.js:1243:15)
    at file:///Users/gabe/VEXUS/server.js:605:42
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - hepatic
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 f7 8d e0 16 ff ef 75 40 39 b2 fb 82 da cb cc 16 40 49 eb 25 fe 7a 7d 7b c5 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 c4 c0 5a 02 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 46 41> ]
  },
  options: {}
}
Scheduling shutdown for hepatic endpoint in 5 minutes
Direct Vertex AI call failed: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30 {
  code: 3,
  details: '',
  metadata: Metadata {
    internalRepr: Map(3) {
      'endpoint-load-metrics-bin' => [Array],
      'grpc-server-stats-bin' => [Array],
      'pc-high-bwd-bin' => [Array]
    },
    options: {}
  }
}
[DIAGNOSTIC] DIRECT_ERROR - hepatic
[DIAGNOSTIC] Error: 3 INVALID_ARGUMENT: 
[DIAGNOSTIC] Stack: Error: 3 INVALID_ARGUMENT: 
    at callErrorFromStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/call.js:31:19)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:192:76)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)
    at Object.onReceiveStatus (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)
    at /Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/resolving-call.js:94:78
    at process.processTicksAndRejections (node:internal/process/task_queues:77:11)
for call at
    at ServiceClientImpl.makeUnaryRequest (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/client.js:160:32)
    at ServiceClientImpl.<anonymous> (/Users/gabe/VEXUS/node_modules/@grpc/grpc-js/build/src/make-client.js:105:19)
    at /Users/gabe/VEXUS/node_modules/@google-cloud/aiplatform/build/src/v1/prediction_service_client.js:219:29
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/timeout.js:44:16
    at OngoingCallPromise.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/call.js:67:27)
    at NormalApiCaller.call (/Users/gabe/VEXUS/node_modules/google-gax/build/src/normalCalls/normalApiCaller.js:34:19)
    at /Users/gabe/VEXUS/node_modules/google-gax/build/src/createApiCall.js:84:30
[DIAGNOSTIC] Error Code: 3
[DIAGNOSTIC] Error Metadata: Metadata {
  internalRepr: Map(3) {
    'endpoint-load-metrics-bin' => [
      <Buffer 31 f7 8d e0 16 ff ef 75 40 39 b2 fb 82 da cb cc 16 40 49 eb 25 fe 7a 7d 7b c5 3f>
    ],
    'grpc-server-stats-bin' => [ <Buffer 00 00 c4 c0 5a 02 00 00 00 00> ],
    'pc-high-bwd-bin' => [ <Buffer 4b 67 49 59 46 41> ]
  },
  options: {}
}
Scheduling shutdown for hepatic endpoint in 5 minutes
Returning prediction error after direct call failed
Prediction request completed in 15201ms
